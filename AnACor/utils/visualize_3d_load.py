import open3d as o3d
import pdb 
import numpy as np

def voxel_grid_to_colored_point_cloud(voxel_grid, color):
    # Extract voxel centers
    voxel_centers = np.asarray(voxel_grid.get_voxels())
    # Create a point cloud
    voxel_centers[0].color = (0,1,0)
    pdb .set_trace()
    point_cloud = o3d.geometry.PointCloud()
    point_cloud.points = o3d.utility.Vector3dVector(voxel_centers)
    # Assign the color
    point_cloud.colors = o3d.utility.Vector3dVector([color for _ in range(len(voxel_centers))])
    return point_cloud


def intersect(initial_point):
    sphere = o3d.geometry.TriangleMesh.create_sphere(radius=2)  # Adjust radius for size
    sphere.translate(initial_point - np.array(sphere.get_center()))  # Center sphere on initial point
    sphere.paint_uniform_color([0, 1, 0])  # Color the sphere green
    return sphere
voxel_grid_li = o3d.io.read_voxel_grid('D:/lys/studystudy/phd/0-Project_absorption_correction/Code_0_for_absorption_correction/ac/class_1_voxel.ply')
voxel_grid_lo = o3d.io.read_voxel_grid('D:/lys/studystudy/phd/0-Project_absorption_correction/Code_0_for_absorption_correction/ac/class_2_voxel.ply')
voxel_grid_cr = o3d.io.read_voxel_grid('D:/lys/studystudy/phd/0-Project_absorption_correction/Code_0_for_absorption_correction/ac/class_3_voxel.ply')
mesh_li= o3d.io.read_triangle_mesh('D:/lys/studystudy/phd/0-Project_absorption_correction/Code_0_for_absorption_correction/ac/class_1_mesh.ply')
mesh_lo= o3d.io.read_triangle_mesh('D:/lys/studystudy/phd/0-Project_absorption_correction/Code_0_for_absorption_correction/ac/class_2_mesh.ply')
mesh_cr= o3d.io.read_triangle_mesh('D:/lys/studystudy/phd/0-Project_absorption_correction/Code_0_for_absorption_correction/ac/class_3_mesh.ply')
 
path=([(288, 559, 403), (288, 558, 402), (288, 558, 401), (288, 557, 400), (288, 557, 399), (288, 557, 398), (288, 556, 397), (288, 556, 396), (288, 556, 395), (288, 555, 394), (288, 555, 393), (288, 555, 392), (288, 554, 391), (288, 554, 390), (288, 554, 389), (288, 553, 388), (288, 553, 387), (288, 552, 386), (288, 552, 385), (288, 552, 384), (288, 551, 383), (288, 551, 382), (288, 551, 381), (288, 550, 380), (288, 550, 379), (288, 550, 378), (288, 549, 377), (289, 549, 376), (289, 549, 375), (289, 548, 374), (289, 548, 373), (289, 547, 372), (289, 547, 371), (289, 547, 370), (289, 546, 369), (289, 546, 368), (289, 546, 367), (289, 545, 366), (289, 545, 365), (289, 545, 364), (289, 544, 363), (289, 544, 362), (289, 544, 361), (289, 543, 360), (289, 543, 359), (289, 542, 358), (289, 542, 357), (289, 542, 356), (289, 541, 355), (289, 541, 354), (289, 541, 353), (289, 540, 352), (289, 540, 351), (290, 540, 350), (290, 539, 349), (290, 539, 348), (290, 539, 347), (290, 538, 346), (290, 538, 345), (290, 538, 344), (290, 537, 343), (290, 537, 342), (290, 536, 341), (290, 536, 340), (290, 536, 339), (290, 535, 338), (290, 535, 337), (290, 535, 336), (290, 534, 335), (290, 534, 334), (290, 534, 333), (290, 533, 332), (290, 533, 331), (290, 533, 330), (290, 532, 329), (290, 532, 328), (290, 531, 327), (290, 531, 326), (290, 531, 325), (291, 530, 324), (291, 530, 323), (291, 530, 322), (291, 529, 321), (291, 529, 320), (291, 529, 319), (291, 528, 318), (291, 528, 317), (291, 528, 316), (291, 527, 315), (291, 527, 314), (291, 526, 313), (291, 526, 312), (291, 526, 311), (291, 525, 310), (291, 525, 309), (291, 525, 308), (291, 524, 307), (291, 524, 306), (291, 524, 305), (291, 523, 304), (291, 523, 303), (291, 523, 302), (291, 522, 301), (291, 522, 300), (291, 521, 299), (291, 521, 298), (292, 521, 297), (292, 520, 296), (292, 520, 295), (292, 520, 294), (292, 519, 293), (292, 519, 292), (292, 519, 291), (292, 518, 290), (292, 518, 289), (292, 518, 288), (292, 517, 287), (292, 517, 286), (292, 517, 285), (292, 516, 284), (292, 516, 283), (292, 515, 282), (292, 515, 281), (292, 515, 280), (292, 514, 279), (292, 514, 278), (292, 514, 277), (292, 513, 276), (292, 513, 275), (292, 513, 274), (292, 512, 273), (292, 512, 272), (293, 512, 271), (293, 511, 270), (293, 511, 269), (293, 510, 268), (293, 510, 267), (293, 510, 266), (293, 509, 265), (293, 509, 264), (293, 509, 263), (293, 508, 262), (293, 508, 261), (293, 508, 260), (293, 507, 259), (293, 507, 258), (293, 507, 257), (293, 506, 256), (293, 506, 255), (293, 505, 254), (293, 505, 253), (293, 505, 252), (293, 504, 251), (293, 504, 250), (293, 504, 249), (293, 503, 248), (293, 503, 247), (293, 503, 246), (294, 502, 245), (294, 502, 244), (294, 502, 243), (294, 501, 242), (294, 501, 241), (294, 500, 240), (294, 500, 239), (294, 500, 238), (294, 499, 237), (294, 499, 236), (294, 499, 235), (294, 498, 234), (294, 498, 233), (294, 498, 232), (294, 497, 231), (294, 497, 230), (294, 497, 229), (294, 496, 228), (294, 496, 227), (294, 496, 226), (294, 495, 225), (294, 495, 224), (294, 494, 223), (294, 494, 222), (294, 494, 221), (294, 493, 220), (295, 493, 219), (295, 493, 218), (295, 492, 217), (295, 492, 216), (295, 492, 215), (295, 491, 214), (295, 491, 213), (295, 491, 212), (295, 490, 211), (295, 490, 210), (295, 489, 209), (295, 489, 208), (295, 489, 207), (295, 488, 206), (295, 488, 205), (295, 488, 204), (295, 487, 203), (295, 487, 202), (295, 487, 201), (295, 486, 200), (295, 486, 199), (295, 486, 198), (295, 485, 197), (295, 485, 196), (295, 484, 195), (295, 484, 194), (295, 484, 193), (296, 483, 192), (296, 483, 191), (296, 483, 190), (296, 482, 189), (296, 482, 188), (296, 482, 187), (296, 481, 186), (296, 481, 185), (296, 481, 184), (296, 480, 183), (296, 480, 182), (296, 479, 181), (296, 479, 180), (296, 479, 179), (296, 478, 178), (296, 478, 177), (296, 478, 176), (296, 477, 175), (296, 477, 174), (296, 477, 173), (296, 476, 172), (296, 476, 171), (296, 476, 170), (296, 475, 169), (296, 475, 168), (296, 475, 167), (297, 474, 166), (297, 474, 165), (297, 473, 164), (297, 473, 163), (297, 473, 162), (297, 472, 161), (297, 472, 160), (297, 472, 159), (297, 471, 158), (297, 471, 157), (297, 471, 156), (297, 470, 155), (297, 470, 154), (297, 470, 153), (297, 469, 152), (297, 469, 151), (297, 468, 150), (297, 468, 149), (297, 468, 148), (297, 467, 147), (297, 467, 146), (297, 467, 145), (297, 466, 144), (297, 466, 143), (297, 466, 142), (297, 465, 141), (298, 465, 140), (298, 465, 139), (298, 464, 138), (298, 464, 137), (298, 463, 136), (298, 463, 135), (298, 463, 134), (298, 462, 133), (298, 462, 132), (298, 462, 131), (298, 461, 130), (298, 461, 129), (298, 461, 128), (298, 460, 127), (298, 460, 126), (298, 460, 125), (298, 459, 124), (298, 459, 123), (298, 458, 122), (298, 458, 121), (298, 458, 120), (298, 457, 119), (298, 457, 118), (298, 457, 117), (298, 456, 116), (298, 456, 115), (299, 456, 114), (299, 455, 113), (299, 455, 112), (299, 455, 111), (299, 454, 110), (299, 454, 109), (299, 454, 108), (299, 453, 107), (299, 453, 106), (299, 452, 105), (299, 452, 104), (299, 452, 103), (299, 451, 102), (299, 451, 101), (299, 451, 100), (299, 450, 99), (299, 450, 98), (299, 450, 97), (299, 449, 96), (299, 449, 95), (299, 449, 94), (299, 448, 93), (299, 448, 92), (299, 447, 91), (299, 447, 90), (299, 447, 89), (299, 446, 88), (300, 446, 87), (300, 446, 86), (300, 445, 85), (300, 445, 84), (300, 445, 83), (300, 444, 82), (300, 444, 81), (300, 444, 80), (300, 443, 79), (300, 443, 78), (300, 442, 77), (300, 442, 76), (300, 442, 75), (300, 441, 74), (300, 441, 73), (300, 441, 72), (300, 440, 71), (300, 440, 70), (300, 440, 69), (300, 439, 68), (300, 439, 67), (300, 439, 66), (300, 438, 65), (300, 438, 64), (300, 438, 63), (300, 437, 62), (301, 437, 61), (301, 436, 60), (301, 436, 59), (301, 436, 58), (301, 435, 57), (301, 435, 56), (301, 435, 55), (301, 434, 54), (301, 434, 53), (301, 434, 52), (301, 433, 51), (301, 433, 50), (301, 433, 49), (301, 432, 48), (301, 432, 47), (301, 431, 46), (301, 431, 45), (301, 431, 44), (301, 430, 43), (301, 430, 42), (301, 430, 41), (301, 429, 40), (301, 429, 39), (301, 429, 38), (301, 428, 37), (301, 428, 36), (302, 428, 35), (302, 427, 34), (302, 427, 33), (302, 426, 32), (302, 426, 31), (302, 426, 30), (302, 425, 29), (302, 425, 28), (302, 425, 27), (302, 424, 26), (302, 424, 25), (302, 424, 24), (302, 423, 23), (302, 423, 22), (302, 423, 21), (302, 422, 20), (302, 422, 19), (302, 421, 18), (302, 421, 17), (302, 421, 16), (302, 420, 15), (302, 420, 14), (302, 420, 13), (302, 419, 12), (302, 419, 11), (302, 419, 10), (303, 418, 9), (303, 418, 8), (303, 418, 7), (303, 417, 6), (303, 417, 5), (303, 417, 4), (303, 416, 3), (303, 416, 2), (303, 415, 1), (303, 415, 0)], [0, 42, 45, 51], ['cr', 'va', 'li', 'va'])
 # 16846 k=524, i=0

# Convert path to Open3D format
intersections=[path[0][i] for i in path[1]]
path_points = np.array(path[0])

lines = [[i, i+1] for i in range(len(path_points)-1)]  # Create lines between consecutive points

# Create a LineSet object
line_set = o3d.geometry.LineSet()
line_set.points = o3d.utility.Vector3dVector(path_points)
line_set.lines = o3d.utility.Vector2iVector(lines)

# Set the color of the lines to black
colors = [[0, 0, 0] for i in range(len(lines))]  # Black color for each line
line_set.colors = o3d.utility.Vector3dVector(colors)

initial_point = path_points[0]  # Get the initial point
intersections_sphere=[intersect(intersections[i]) for i in range(len(intersections))]
# pdb.set_trace()
# 
# o3d.visualization.draw_geometries([mesh_li,mesh_lo,mesh_cr,line_set]+intersections_sphere, window_name="Voxel Grid Visualization")
color_li = [0, 0, 1]  # Blue
color_lo = [1, 1, 0]  # Yellow
color_cr = [1, 0, 0]  # Red

# Convert each voxel grid to a colored point cloud
pcd_li = voxel_grid_to_colored_point_cloud(voxel_grid_li, color_li)
pcd_lo = voxel_grid_to_colored_point_cloud(voxel_grid_lo, color_lo)
pcd_cr = voxel_grid_to_colored_point_cloud(voxel_grid_cr, color_cr)

# Combine the point clouds for visualization
combined_pcd = pcd_li + pcd_lo + pcd_cr

# Visualize the combined point cloud
o3d.visualization.draw_geometries([combined_pcd])
# pdb.set_trace()   
# o3d.visualization.draw_geometries([voxel_grid_li,voxel_grid_lo,voxel_grid_cr], window_name="Voxel Grid Visualization")